@using System.Reactive
@using Phazor.Components.Tools
@using Microsoft.Extensions.Options
@using Microsoft.Extensions.Logging
@using Phazor.Extensions
@namespace Phazor.Components
@typeparam T
@inject IOptionsMonitor<PhazorComponentsOptions> Options
@inject ILogger<PhazorReactiveValue<T>> Logger

@if (_value is not null && _hasValue && ChildContent is not null)
{
    @ChildContent.Invoke(_value)
}

@code {

    private IDisposable? _disposable;

    private bool _hasValue;
    private T? _value;

    [Parameter]
    public IObservable<T>? Value { get; set; }

    [Parameter]
    public RenderFragment<T>? ChildContent { get; set; }

    [Parameter]
    public EventCallback<T>? ValueChanged { get; set; }

    [Parameter]
    public IObservable<Unit>? ChangeToken { get; set; }

    protected override void OnParametersSet()
    {
        _disposable?.Dispose();

        _disposable = Value?.Subscribe(x =>
        {
            if (Options.CurrentValue.Trace)
            {
                Logger.LogInformation(
                    "PhazorReactiveValue<{Type}> received value = {Value}",
                    typeof(T).Name,
                    x);
            }

            _hasValue = true;
            _value = x;

            ValueChanged?.InvokeAsync(x);

            StateHasChanged();
        });

        _disposable = _disposable.Combine(ChangeToken?.Subscribe(_ => StateHasChanged()));
    }

}